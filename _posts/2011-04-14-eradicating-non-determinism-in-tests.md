---
title: テストにおける非決定性の排除
tags: [continuous integration, delivery, testing]
---

[Eradicating Non-Determinism in Tests](https://martinfowler.com/articles/nonDeterminism.html)

自動化されたリグレッションスイートは、ソフトウェアプロジェクトにおいて本番環境の欠陥を減らし、進化的設計を実現するうえで重要な役割を果たします。開発チームと話をする中で、私は非決定的なテストの問題についてよく耳にします。非決定的なテストとは成功したり失敗したりするようなテストのことです。制御されていないまま放置された非決定的テストは、自動化されたリグレッションスイートの価値を完全に破壊してしまう可能性があります。この記事では、非決定的テストに対処する方法の概要を説明します。手始めにはそういったテストを隔離することで他のテストへのダメージを減らすことができますが、それでもすぐに修正しなければなりません。そのため、非決定的テストのよくある原因である、分離の欠如、非同期的な挙動、リモートサービス、時間、リソースリークなどへの対処法について説明します。

<!-- TOC -->
- [なぜ非決定的なテストは問題なのか](#なぜ非決定的なテストは問題なのか)
- [隔離](#隔離)
- [分離の欠如](#分離の欠如)
- [非同期的な挙動](#非同期的な挙動)
- [リモートサービス](#リモートサービス)
- [時間](#時間)
- [リソースリーク](#リソースリーク)

<!-- /TOC -->

私は、ThoughtWorksが多くの困難なエンタープライズアプリケーションに取り組み、これまでほとんど成功したことのない多くのクライアントに成功をもたらしているのを見て楽しんでいました。私たちの経験によって、10年前にマニフェストを書いたときには物議をかもしていたアジャイル手法がソフトウェア開発を成功に導くことを実証してきました。

アジャイル開発には様々な種類がありますが、私たちが行っていることの中では自動テストが中心的な役割を果たしています。自動テストは、エクストリームプログラミングの最初からの中核的なアプローチであり、その哲学が私たちのアジャイル開発の最大のインスピレーションとなっています。そのため、私たちはソフトウェア開発の中核となる部分として自動テストを使用する多くの経験を積んできました。

自動テストは、書籍の中で読む限りは簡単に見えるかもしれません。実際、基本的な考え方は非常にシンプルです。しかし、納品プロジェクトのプレッシャーの中では、書籍ではあまり注目されていないような試練が降りかかります。私もよく知っていますが、書籍の著者は核心を突くために多くの詳細を省く傾向があります。私たちのデリバリチームとの会話の中で、私たちが繰り返し遭遇する問題の1つは、テストが信頼性を欠くようになり、信頼性が低すぎて人々がテストが成功するか失敗するかに注意を払わなくなるというものです。この信頼性の低さの主な原因は、いくつかのテストが非決定的になっていることです。

テストが非決定的であるというのは、コードやテスト、環境に変更がなくても、成功したり失敗したりする場合です。そのようなテストは、失敗した後再実行すると合格します。このようなテストの失敗は、一見ランダムに見えます。

非決定性はあらゆる種類のテストに害をもたらしますが、特に受け入れテストや機能テストのような広い範囲のテストに影響を与えやすいです。

## なぜ非決定的なテストは問題なのか
